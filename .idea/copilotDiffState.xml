<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/myapplication/ui/password/ResetPasswordActivity.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/myapplication/ui/password/ResetPasswordActivity.kt" />
              <option name="updatedContent" value="package com.example.myapplication.ui.password&#10;&#10;import android.content.Intent&#10;import android.graphics.Color&#10;import android.os.Bundle&#10;import android.text.Editable&#10;import android.text.TextWatcher&#10;import android.widget.TextView&#10;import android.widget.Toast&#10;import androidx.appcompat.app.AppCompatActivity&#10;import androidx.core.content.ContextCompat&#10;import androidx.lifecycle.lifecycleScope&#10;import com.example.myapplication.R&#10;import com.example.myapplication.database.AppDatabase&#10;import com.example.myapplication.ui.login.LoginActivity&#10;import com.example.myapplication.util.EncryptionUtil&#10;import com.example.myapplication.util.PasswordValidator&#10;import com.google.android.material.button.MaterialButton&#10;import com.google.android.material.textfield.TextInputEditText&#10;import kotlinx.coroutines.Dispatchers&#10;import kotlinx.coroutines.launch&#10;import kotlinx.coroutines.withContext&#10;&#10;class ResetPasswordActivity : AppCompatActivity() {&#10;&#10;    private lateinit var tvEmailDisplay: TextView&#10;    private lateinit var etNewPassword: TextInputEditText&#10;    private lateinit var etConfirmNewPassword: TextInputEditText&#10;    private lateinit var btnChangePassword: MaterialButton&#10;    private lateinit var tvCancelReset: TextView&#10;    &#10;    // Indicadores visuales de requisitos&#10;    private lateinit var tvReqLength: TextView&#10;    private lateinit var tvReqUppercase: TextView&#10;    private lateinit var tvReqNumber: TextView&#10;&#10;    private val db by lazy { AppDatabase.getInstance(applicationContext) }&#10;    private val usuarioDao by lazy { db.usuarioDao() }&#10;&#10;    private var email: String? = null&#10;    private var token: String? = null&#10;&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        super.onCreate(savedInstanceState)&#10;        setContentView(R.layout.activity_reset_password)&#10;&#10;        // Obtener datos del Intent (desde Deep Link)&#10;        email = intent.data?.getQueryParameter(&quot;email&quot;) ?: intent.getStringExtra(&quot;email&quot;)&#10;        token = intent.data?.getQueryParameter(&quot;token&quot;) ?: intent.getStringExtra(&quot;token&quot;)&#10;&#10;        // Validar que tengamos los datos necesarios&#10;        if (email.isNullOrEmpty() || token.isNullOrEmpty()) {&#10;            Toast.makeText(this, &quot;❌ Link inválido o expirado&quot;, Toast.LENGTH_LONG).show()&#10;            finish()&#10;            return&#10;        }&#10;&#10;        // Validar que el token sea válido y no haya expirado&#10;        if (!isTokenValid(token!!)) {&#10;            Toast.makeText(&#10;                this,&#10;                &quot;❌ Este enlace ha expirado.\nSolicita uno nuevo desde 'Olvidé mi contraseña'&quot;,&#10;                Toast.LENGTH_LONG&#10;            ).show()&#10;            finish()&#10;            return&#10;        }&#10;&#10;        initializeViews()&#10;        setupListeners()&#10;        displayEmail()&#10;    }&#10;&#10;    private fun initializeViews() {&#10;        tvEmailDisplay = findViewById(R.id.tvEmailDisplay)&#10;        etNewPassword = findViewById(R.id.etNewPassword)&#10;        etConfirmNewPassword = findViewById(R.id.etConfirmNewPassword)&#10;        btnChangePassword = findViewById(R.id.btnChangePassword)&#10;        tvCancelReset = findViewById(R.id.tvCancelReset)&#10;        &#10;        tvReqLength = findViewById(R.id.tvReqLength)&#10;        tvReqUppercase = findViewById(R.id.tvReqUppercase)&#10;        tvReqNumber = findViewById(R.id.tvReqNumber)&#10;    }&#10;&#10;    private fun setupListeners() {&#10;        // Validación en tiempo real mientras escribe&#10;        etNewPassword.addTextChangedListener(object : TextWatcher {&#10;            override fun beforeTextChanged(s: CharSequence?, start: Int, count: Int, after: Int) {}&#10;            override fun onTextChanged(s: CharSequence?, start: Int, before: Int, count: Int) {}&#10;            override fun afterTextChanged(s: Editable?) {&#10;                val password = s?.toString() ?: &quot;&quot;&#10;                updatePasswordRequirements(password)&#10;            }&#10;        })&#10;&#10;        btnChangePassword.setOnClickListener {&#10;            handlePasswordChange()&#10;        }&#10;&#10;        tvCancelReset.setOnClickListener {&#10;            finish()&#10;            startActivity(Intent(this, LoginActivity::class.java))&#10;        }&#10;    }&#10;&#10;    private fun displayEmail() {&#10;        tvEmailDisplay.text = email&#10;    }&#10;&#10;    /**&#10;     * Actualiza visualmente los requisitos de contraseña&#10;     */&#10;    private fun updatePasswordRequirements(password: String) {&#10;        val validation = PasswordValidator.validate(password)&#10;        &#10;        val colorValid = ContextCompat.getColor(this, R.color.green_success)&#10;        val colorInvalid = Color.parseColor(&quot;#757575&quot;)&#10;        val iconValid = R.drawable.ic_check_circle&#10;        val iconInvalid = R.drawable.ic_circle_outline&#10;&#10;        // Longitud&#10;        tvReqLength.setTextColor(if (validation.meetsLength) colorValid else colorInvalid)&#10;        tvReqLength.setCompoundDrawablesRelativeWithIntrinsicBounds(&#10;            if (validation.meetsLength) iconValid else iconInvalid, 0, 0, 0&#10;        )&#10;&#10;        // Mayúscula&#10;        tvReqUppercase.setTextColor(if (validation.meetsUppercase) colorValid else colorInvalid)&#10;        tvReqUppercase.setCompoundDrawablesRelativeWithIntrinsicBounds(&#10;            if (validation.meetsUppercase) iconValid else iconInvalid, 0, 0, 0&#10;        )&#10;&#10;        // Número&#10;        tvReqNumber.setTextColor(if (validation.meetsNumber) colorValid else colorInvalid)&#10;        tvReqNumber.setCompoundDrawablesRelativeWithIntrinsicBounds(&#10;            if (validation.meetsNumber) iconValid else iconInvalid, 0, 0, 0&#10;        )&#10;    }&#10;&#10;    /**&#10;     * Maneja el cambio de contraseña&#10;     */&#10;    private fun handlePasswordChange() {&#10;        val newPassword = etNewPassword.text?.toString() ?: &quot;&quot;&#10;        val confirmPassword = etConfirmNewPassword.text?.toString() ?: &quot;&quot;&#10;&#10;        // Limpiar errores previos&#10;        etNewPassword.error = null&#10;        etConfirmNewPassword.error = null&#10;&#10;        // Validar contraseña&#10;        val validation = PasswordValidator.validate(newPassword)&#10;        if (!validation.isValid) {&#10;            etNewPassword.error = PasswordValidator.getErrorMessage(validation)&#10;            Toast.makeText(this, &quot;❌ La contraseña no cumple los requisitos&quot;, Toast.LENGTH_LONG).show()&#10;            return&#10;        }&#10;&#10;        // Verificar que coincidan&#10;        if (!PasswordValidator.passwordsMatch(newPassword, confirmPassword)) {&#10;            etConfirmNewPassword.error = &quot;Las contraseñas no coinciden&quot;&#10;            Toast.makeText(this, &quot;❌ Las contraseñas no coinciden&quot;, Toast.LENGTH_LONG).show()&#10;            return&#10;        }&#10;&#10;        // Deshabilitar botón mientras se procesa&#10;        btnChangePassword.isEnabled = false&#10;        btnChangePassword.text = &quot;Actualizando...&quot;&#10;&#10;        // Actualizar contraseña en la base de datos&#10;        lifecycleScope.launch(Dispatchers.IO) {&#10;            try {&#10;                val user = usuarioDao.getUserByEmail(email!!)&#10;                &#10;                if (user == null) {&#10;                    withContext(Dispatchers.Main) {&#10;                        Toast.makeText(&#10;                            this@ResetPasswordActivity,&#10;                            &quot;❌ Usuario no encontrado&quot;,&#10;                            Toast.LENGTH_LONG&#10;                        ).show()&#10;                        btnChangePassword.isEnabled = true&#10;                        btnChangePassword.text = &quot;Cambiar Contraseña&quot;&#10;                    }&#10;                    return@launch&#10;                }&#10;&#10;                // Cifrar nueva contraseña&#10;                val encryptedPassword = EncryptionUtil.encryptPassword(newPassword)&#10;                &#10;                // Actualizar contraseña en Room&#10;                val updatedUser = user.copy(passwordHash = encryptedPassword)&#10;                usuarioDao.actualizar(updatedUser)&#10;                &#10;                // También actualizar en Firebase (opcional pero recomendado)&#10;                com.example.myapplication.cloud.FirebaseService.actualizarContrasena(email!!, encryptedPassword)&#10;                &#10;                // Invalidar el token usado&#10;                invalidateToken(token!!)&#10;&#10;                withContext(Dispatchers.Main) {&#10;                    // Mostrar diálogo de éxito&#10;                    showSuccessDialog()&#10;                }&#10;&#10;            } catch (e: Exception) {&#10;                withContext(Dispatchers.Main) {&#10;                    Toast.makeText(&#10;                        this@ResetPasswordActivity,&#10;                        &quot;❌ Error al actualizar contraseña: ${e.message}&quot;,&#10;                        Toast.LENGTH_LONG&#10;                    ).show()&#10;                    btnChangePassword.isEnabled = true&#10;                    btnChangePassword.text = &quot;Cambiar Contraseña&quot;&#10;                    android.util.Log.e(&quot;ResetPassword&quot;, &quot;Error: ${e.message}&quot;, e)&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Verifica que el token sea válido y no haya expirado&#10;     */&#10;    private fun isTokenValid(token: String): Boolean {&#10;        val prefs = getSharedPreferences(&quot;password_reset&quot;, MODE_PRIVATE)&#10;        val savedEmail = prefs.getString(&quot;token_$token&quot;, null)&#10;        val timestamp = prefs.getLong(&quot;timestamp_$token&quot;, 0)&#10;&#10;        // Verificar que el token existe y coincide con el email&#10;        if (savedEmail != email) {&#10;            android.util.Log.w(&quot;ResetPassword&quot;, &quot;Token no coincide con email&quot;)&#10;            return false&#10;        }&#10;&#10;        // Verificar que no haya expirado (1 hora = 3600000 ms)&#10;        val oneHour = 3600000L&#10;        val isExpired = (System.currentTimeMillis() - timestamp) &gt; oneHour&#10;&#10;        if (isExpired) {&#10;            android.util.Log.w(&quot;ResetPassword&quot;, &quot;Token expirado&quot;)&#10;        }&#10;&#10;        return !isExpired&#10;    }&#10;&#10;    /**&#10;     * Invalida el token después de usarlo&#10;     */&#10;    private fun invalidateToken(token: String) {&#10;        val prefs = getSharedPreferences(&quot;password_reset&quot;, MODE_PRIVATE)&#10;        prefs.edit().apply {&#10;            remove(&quot;token_$token&quot;)&#10;            remove(&quot;timestamp_$token&quot;)&#10;            apply()&#10;        }&#10;        android.util.Log.d(&quot;ResetPassword&quot;, &quot;Token invalidado: $token&quot;)&#10;    }&#10;&#10;    /**&#10;     * Muestra diálogo de éxito y redirige al login&#10;     */&#10;    private fun showSuccessDialog() {&#10;        val builder = androidx.appcompat.app.AlertDialog.Builder(this)&#10;        builder.setTitle(&quot;✅ Contraseña Actualizada&quot;)&#10;        builder.setMessage(&quot;Tu contraseña ha sido actualizada exitosamente.\n\n¡Ya puedes iniciar sesión con tu nueva contraseña!&quot;)&#10;        builder.setPositiveButton(&quot;Ir al Login&quot;) { dialog, _ -&gt;&#10;            dialog.dismiss()&#10;            navigateToLogin()&#10;        }&#10;        builder.setCancelable(false)&#10;        builder.show()&#10;    }&#10;&#10;    /**&#10;     * Redirige al login limpiando el stack de actividades&#10;     */&#10;    private fun navigateToLogin() {&#10;        val intent = Intent(this, LoginActivity::class.java)&#10;        intent.flags = Intent.FLAG_ACTIVITY_CLEAR_TOP or Intent.FLAG_ACTIVITY_NEW_TASK&#10;        startActivity(intent)&#10;        finish()&#10;    }&#10;&#10;    override fun onBackPressed() {&#10;        // Prevenir volver atrás, solo permitir ir al login&#10;        navigateToLogin()&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/myapplication/util/PasswordValidator.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/myapplication/util/PasswordValidator.kt" />
              <option name="updatedContent" value="package com.example.myapplication.util&#10;&#10;/**&#10; * Utilidad para validar contraseñas con requisitos de seguridad&#10; */&#10;object PasswordValidator {&#10;    &#10;    /**&#10;     * Resultado de la validación de contraseña&#10;     */&#10;    data class ValidationResult(&#10;        val isValid: Boolean,&#10;        val errors: List&lt;String&gt; = emptyList(),&#10;        val meetsLength: Boolean = false,&#10;        val meetsUppercase: Boolean = false,&#10;        val meetsNumber: Boolean = false&#10;    )&#10;    &#10;    /**&#10;     * Requisitos mínimos de contraseña&#10;     */&#10;    const val MIN_LENGTH = 8&#10;    &#10;    /**&#10;     * Valida una contraseña con todos los requisitos&#10;     */&#10;    fun validate(password: String): ValidationResult {&#10;        val errors = mutableListOf&lt;String&gt;()&#10;        &#10;        // Verificar longitud mínima&#10;        val meetsLength = password.length &gt;= MIN_LENGTH&#10;        if (!meetsLength) {&#10;            errors.add(&quot;La contraseña debe tener al menos $MIN_LENGTH caracteres&quot;)&#10;        }&#10;        &#10;        // Verificar mayúscula&#10;        val meetsUppercase = password.any { it.isUpperCase() }&#10;        if (!meetsUppercase) {&#10;            errors.add(&quot;La contraseña debe contener al menos una letra mayúscula&quot;)&#10;        }&#10;        &#10;        // Verificar número&#10;        val meetsNumber = password.any { it.isDigit() }&#10;        if (!meetsNumber) {&#10;            errors.add(&quot;La contraseña debe contener al menos un número&quot;)&#10;        }&#10;        &#10;        return ValidationResult(&#10;            isValid = errors.isEmpty(),&#10;            errors = errors,&#10;            meetsLength = meetsLength,&#10;            meetsUppercase = meetsUppercase,&#10;            meetsNumber = meetsNumber&#10;        )&#10;    }&#10;    &#10;    /**&#10;     * Verifica que las dos contraseñas coincidan&#10;     */&#10;    fun passwordsMatch(password: String, confirmPassword: String): Boolean {&#10;        return password == confirmPassword&#10;    }&#10;    &#10;    /**&#10;     * Obtiene un mensaje de error amigable para el usuario&#10;     */&#10;    fun getErrorMessage(result: ValidationResult): String {&#10;        return when {&#10;            result.errors.isEmpty() -&gt; &quot;&quot;&#10;            result.errors.size == 1 -&gt; result.errors[0]&#10;            else -&gt; &quot;La contraseña no cumple los requisitos:\n${result.errors.joinToString(&quot;\n• &quot;, &quot;• &quot;)}&quot;&#10;        }&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/res/drawable/circle_background.xml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/res/drawable/circle_background.xml" />
              <option name="updatedContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;shape xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    android:shape=&quot;oval&quot;&gt;&#10;    &lt;solid android:color=&quot;#9C27B0&quot; /&gt;&#10;&lt;/shape&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/res/drawable/gradient_background_login.xml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/res/drawable/gradient_background_login.xml" />
              <option name="updatedContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;shape xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    android:shape=&quot;rectangle&quot;&gt;&#10;    &lt;gradient&#10;        android:angle=&quot;135&quot;&#10;        android:startColor=&quot;#9C27B0&quot;&#10;        android:centerColor=&quot;#7B1FA2&quot;&#10;        android:endColor=&quot;#54075D&quot;&#10;        android:type=&quot;linear&quot; /&gt;&#10;&lt;/shape&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/res/drawable/ic_check_circle.xml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/res/drawable/ic_check_circle.xml" />
              <option name="updatedContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;vector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    android:width=&quot;24dp&quot;&#10;    android:height=&quot;24dp&quot;&#10;    android:viewportWidth=&quot;24&quot;&#10;    android:viewportHeight=&quot;24&quot;&gt;&#10;    &lt;path&#10;        android:fillColor=&quot;#4CAF50&quot;&#10;        android:pathData=&quot;M12,2C6.48,2 2,6.48 2,12s4.48,10 10,10 10,-4.48 10,-10S17.52,2 12,2zM10,17l-5,-5 1.41,-1.41L10,14.17l7.59,-7.59L19,8l-9,9z&quot;/&gt;&#10;&lt;/vector&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/res/drawable/ic_circle_outline.xml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/res/drawable/ic_circle_outline.xml" />
              <option name="updatedContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;vector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    android:width=&quot;24dp&quot;&#10;    android:height=&quot;24dp&quot;&#10;    android:viewportWidth=&quot;24&quot;&#10;    android:viewportHeight=&quot;24&quot;&gt;&#10;    &lt;path&#10;        android:fillColor=&quot;#757575&quot;&#10;        android:pathData=&quot;M12,2C6.48,2 2,6.48 2,12s4.48,10 10,10 10,-4.48 10,-10S17.52,2 12,2zM12,20c-4.42,0 -8,-3.58 -8,-8s3.58,-8 8,-8 8,3.58 8,8 -3.58,8 -8,8z&quot;/&gt;&#10;&lt;/vector&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/res/drawable/ic_lock_reset.xml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/res/drawable/ic_lock_reset.xml" />
              <option name="updatedContent" value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&#10;&lt;vector xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&#10;    android:width=&quot;24dp&quot;&#10;    android:height=&quot;24dp&quot;&#10;    android:viewportWidth=&quot;24&quot;&#10;    android:viewportHeight=&quot;24&quot;&gt;&#10;    &lt;path&#10;        android:fillColor=&quot;#FFFFFF&quot;&#10;        android:pathData=&quot;M18,8h-1L17,6c0,-2.76 -2.24,-5 -5,-5S7,3.24 7,6v2L6,8c-1.1,0 -2,0.9 -2,2v10c0,1.1 0.9,2 2,2h12c1.1,0 2,-0.9 2,-2L20,10c0,-1.1 -0.9,-2 -2,-2zM12,17c-1.1,0 -2,-0.9 -2,-2s0.9,-2 2,-2 2,0.9 2,2 -0.9,2 -2,2zM15.1,8L8.9,8L8.9,6c0,-1.71 1.39,-3.1 3.1,-3.1 1.71,0 3.1,1.39 3.1,3.1v2z&quot;/&gt;&#10;&lt;/vector&gt;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>